//=======================================================================
//			Copyright XashXT Group 2010 ©
//		        vgi_int.c - vgui dll interaction
//=======================================================================

#include "common.h"
#include "client.h"
#include "const.h"

#include<VGUI.h>
#include<VGUI_App.h>
#include<VGUI_Panel.h>
#include<VGUI_SurfaceGL.h>
#include<VGUI_ActionSignal.h>
#include<VGUI_BorderLayout.h>

using namespace vgui;

void App::main(int argc,char* argv[])
{
}

SurfaceGL::SurfaceGL( Panel* embeddedPanel ):Surface( embeddedPanel )
{
	_embeddedPanel = embeddedPanel;
}

bool SurfaceGL::recreateContext( void )
{
	return false;
}

void SurfaceGL::createPopup(Panel* embeddedPanel)
{
}
	
void SurfaceGL::pushMakeCurrent( Panel* panel, bool useInsets )
{
}

void SurfaceGL::popMakeCurrent( Panel* panel )
{
}

void SurfaceGL::makeCurrent( void )
{
	Msg( "makeCurrent()\n" );
}

void SurfaceGL::swapBuffers( void )
{
	Msg( "swapBuffers()\n" );
	V_PostRender ();
}

void SurfaceGL::setColor( int r, int g, int b )
{
}

void SurfaceGL::filledRect( int x0, int y0, int x1, int y1 )
{
}

void SurfaceGL::outlinedRect( int x0, int y0, int x1, int y1 )
{
}

void SurfaceGL::setTextFont( Font* font )
{
}

void SurfaceGL::setTextColor( int r, int g, int b )
{
}

void SurfaceGL::setDrawPos( int x, int y )
{
}

void SurfaceGL::printText( const char *str, int strlen )
{
	Msg( "Con_Printf( %s )\n", str );
}

void SurfaceGL::setTextureRGBA( int id, const char *rgba, int wide, int tall )
{
	Msg( "SetTexture( %i )\n", id );
}

void SurfaceGL::setTexture( int id )
{
	Msg( "SetTexture( %i )\n", id );
}

void SurfaceGL::texturedRect( int x0, int y0, int x1, int y1 )
{
}

class CEngineApp : public App
{
public:
	CEngineApp( bool externalMain ):App( externalMain )
	{
	}

	virtual void main( int argc, char* argv[] )
	{
		Msg( "App main()\n" );
	}

	virtual void setCursorPos( int x, int y )
	{
		Msg( "setCursorPos: %i %i\n", x, y );
	}
	
	virtual void getCursorPos( int &x,int &y )
	{
		App::getCursorPos( x, y );
		Msg( "getCursorPos: %i %i\n", x, y );
	}
	virtual App* getApp( void )
	{
		return this;
	}
};

SurfaceGL		*surface = NULL;
CEngineApp	*pApp = NULL;
Panel		*rootpanel = NULL;

void VGui_SetBounds( void )
{
	convar_t	*r_xpos = Cvar_FindVar( "r_xpos" );
	convar_t	*r_ypos = Cvar_FindVar( "r_ypos" );

	if( !rootpanel || !r_xpos || !r_ypos ) return;

	rootpanel->setBounds( r_xpos->integer, r_ypos->integer, menu.globals->scrWidth, menu.globals->scrHeight );
}

void VGui_Startup( void )
{
	if( rootpanel )
	{
//		rootpanel->reset();
		return;
	}

	pApp = new CEngineApp( true );
	rootpanel = new Panel( 0, 0, menu.globals->scrWidth, menu.globals->scrHeight );
	surface = new SurfaceGL( rootpanel );

	rootpanel->setVisible( true );
	rootpanel->setEnabled( true );
//	rootpanel->setPaintEnabled( false );
//	rootpanel->setPaintBorderEnabled( false );
//	rootpanel->setPaintBackgroundEnabled( true );

	VGui_SetBounds();

	ASSERT( rootpanel->getApp() != NULL );
	ASSERT( rootpanel->getSurfaceBase() != NULL );
	ASSERT( rootpanel->getApp() == pApp );
}

void VGui_Shutdown( void )
{
	delete rootpanel;
	delete surface;
	delete pApp;

	rootpanel = NULL;
	surface = NULL;
	pApp = NULL;
}

void VGui_Paint( void )
{
	if( !rootpanel ) return;

	pApp->externalTick();
//	rootpanel->paintBackground();
}

void VGui_ViewportPaintBackground( int extents[4] )
{
	if( !rootpanel ) return;

	Msg( "ViewportPaintBackground( %i, %i, %i, %i )\n", extents[0], extents[1], extents[2], extents[3] );

	V_RenderView();
	rootpanel->repaint();

	// paint everything 
//	rootpanel->paintTraverse();
}

void *VGui_GetPanel( void )
{
	return (void *)rootpanel;
}